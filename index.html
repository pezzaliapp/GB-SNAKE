<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0e1a12" />
  <link rel="manifest" href="manifest.webmanifest">
  <title>GB Snake — Free</title>
  <style>
    :root{
      --bg:#0a120d;
      --shell:#c9c7b8;
      --shell2:#bdbbad;
      --bezel:#1b2a21;
      --screen:#b9caa6;
      --screen2:#9fb18f;
      --ink:#142016;
      --btn:#6b6a63;
      --btn2:#5b5a54;
      --accent:#9a2240;
      --shadow: rgba(0,0,0,.28);
      --font: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background: radial-gradient(1200px 800px at 50% -10%, #1b2a21, var(--bg));
      color:#eef3ea; font-family: var(--font);
      min-height:100svh; display:flex; align-items:center; justify-content:center;
      padding:16px;
    }
    .wrap{width:min(440px, 100%);}
    .handheld{
      background: linear-gradient(180deg, var(--shell), var(--shell2));
      border-radius: 34px;
      box-shadow: 0 18px 60px var(--shadow);
      padding: 18px 18px 22px;
      border: 1px solid rgba(255,255,255,.35);
      position: relative;
      overflow: hidden;
    }
    .handheld:before{
      content:""; position:absolute; inset:-40px -40px auto auto; width:140px; height:140px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.45), rgba(255,255,255,0));
      transform: rotate(18deg);
      pointer-events:none;
    }
    .brand{
      display:flex; align-items:center; justify-content:space-between;
      padding: 2px 6px 10px;
      color:#2c3a31; font-weight:700; letter-spacing:.08em; font-size:12px;
    }
    .brand small{opacity:.75; font-weight:700}
    .screen-bezel{
      background: linear-gradient(180deg, #22352b, var(--bezel));
      border-radius: 18px;
      padding: 14px;
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: inset 0 10px 20px rgba(0,0,0,.28);
    }
    .screen{
      background: linear-gradient(180deg, var(--screen), var(--screen2));
      border-radius: 10px;
      padding: 12px;
      border: 1px solid rgba(0,0,0,.25);
      position: relative;
    }
    canvas{
      width:100%; height:auto; display:block;
      image-rendering: pixelated;
      border-radius: 8px;
      background: rgba(0,0,0,.08);
    }
    .hud{
      position:absolute; inset:10px 10px auto 10px;
      display:flex; justify-content:space-between; gap:10px;
      color: var(--ink);
      font-weight: 900;
      font-size: 12px;
      text-shadow: 0 1px 0 rgba(255,255,255,.18);
      pointer-events:none;
    }
    .hint{
      margin-top:10px; opacity:.85; font-size:12px; line-height:1.3;
      color:#1c2b22; background: rgba(255,255,255,.35);
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 12px; padding: 8px 10px;
    }
    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 18px;
      align-items:center;
    }
    .dpad{
      width: 160px; height: 160px;
      margin: 0 auto;
      position: relative;
      filter: drop-shadow(0 8px 12px rgba(0,0,0,.18));
      -webkit-user-select:none; user-select:none;
      touch-action: manipulation;
    }
    .dpad button{
      position:absolute;
      border: 0;
      background: linear-gradient(180deg, var(--btn), var(--btn2));
      color: rgba(255,255,255,.8);
      font-weight: 900;
      border-radius: 14px;
      box-shadow: inset 0 2px 0 rgba(255,255,255,.18), 0 8px 16px rgba(0,0,0,.22);
      -webkit-tap-highlight-color: transparent;
      cursor:pointer;
      touch-action: manipulation;
    }
    .dpad .up{ left:50%; top:0; transform:translateX(-50%); width:58px; height:58px;}
    .dpad .down{ left:50%; bottom:0; transform:translateX(-50%); width:58px; height:58px;}
    .dpad .left{ left:0; top:50%; transform:translateY(-50%); width:58px; height:58px;}
    .dpad .right{ right:0; top:50%; transform:translateY(-50%); width:58px; height:58px;}
    .dpad .mid{
      left:50%; top:50%; transform:translate(-50%,-50%);
      width:62px; height:62px; border-radius: 18px;
      background: linear-gradient(180deg, #4f4e48, #3f3e39);
      pointer-events:none;
    }
    .ab{
      display:flex; justify-content:center; gap:14px; align-items:center;
      -webkit-user-select:none; user-select:none;
      touch-action: manipulation;
    }
    .ab .big{
      width:66px; height:66px;
      border-radius: 999px;
      border:0;
      background: radial-gradient(circle at 30% 30%, #cf2a52, var(--accent));
      box-shadow: inset 0 2px 0 rgba(255,255,255,.18), 0 10px 18px rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      font-weight: 900;
      font-size: 16px;
      -webkit-tap-highlight-color: transparent;
      cursor:pointer;
      touch-action: manipulation;
    }
    .ab .smallrow{ display:flex; gap:10px; margin-left:8px; }
    .ab .small{
      width:64px; height:30px;
      border-radius: 999px;
      border:0;
      background: linear-gradient(180deg, #78776f, #64635c);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.16), 0 8px 14px rgba(0,0,0,.18);
      color: rgba(255,255,255,.9);
      font-weight: 900;
      font-size: 12px;
      -webkit-tap-highlight-color: transparent;
      cursor:pointer;
      touch-action: manipulation;
    }
    .footer{
      display:flex; justify-content:space-between; gap:12px; margin-top: 10px;
      color:#24332a; font-size:11px; opacity:.9;
      padding: 0 6px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="handheld">
      <div class="brand">
        <div>GB SNAKE <small>FREE</small></div>
        <div style="opacity:.75; font-weight:800;">Installabile</div>
      </div>

      <div class="screen-bezel">
        <div class="screen">
          <div class="hud">
            <div id="score">SCORE 000</div>
            <div id="best">BEST 000</div>
          </div>
          <canvas id="c" width="256" height="256" aria-label="Gioco Snake"></canvas>
          <div class="hint" id="msg">
            Premi A o START per iniziare. B = Restart.
          </div>
        </div>
      </div>

      <div class="controls">
        <div class="dpad" aria-label="D-Pad">
          <button type="button" class="up" data-dir="U">▲</button>
          <button type="button" class="down" data-dir="D">▼</button>
          <button type="button" class="left" data-dir="L">◀</button>
          <button type="button" class="right" data-dir="R">▶</button>
          <div class="mid"></div>
        </div>

        <div class="ab" aria-label="Pulsanti">
          <button type="button" class="big" id="btnA">A</button>
          <button type="button" class="big" id="btnB">B</button>
          <div class="smallrow">
            <button type="button" class="small" id="btnSel">SEL</button>
            <button type="button" class="small" id="btnStart">START</button>
          </div>
        </div>
      </div>

      <div class="footer">
        <div>Offline ✔︎</div>
        <div>© Free mini-PWA</div>
      </div>
    </div>
  </div>

<script>
(() => {
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
  }

  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  const scoreEl = document.getElementById('score');
  const bestEl  = document.getElementById('best');
  const msgEl   = document.getElementById('msg');

  const GRID = 16;
  const CELL = canvas.width / GRID;
  const INK  = '#142016';

  const storageBest = 'gb_snake_best_v1';
  let best = Number(localStorage.getItem(storageBest) || 0);

  function pad3(n){ return String(n).padStart(3,'0'); }
  function updateHUD() {
    scoreEl.textContent = `SCORE ${pad3(score)}`;
    bestEl.textContent  = `BEST ${pad3(best)}`;
  }

  let snake, dir, nextDir, food, score;
  let running = true, paused = true, dead = false;
  let waitingStart = true;

  // loop fluido
  let tickMs = 110;
  let acc = 0;
  let last = 0;
  let rafId = 0;

  function spawnFood() {
    const occupied = new Set(snake.map(p => `${p.x},${p.y}`));
    while (true) {
      const x = Math.floor(Math.random()*GRID);
      const y = Math.floor(Math.random()*GRID);
      if (!occupied.has(`${x},${y}`)) { food = {x,y}; return; }
    }
  }

  function reset() {
    snake = [{x:8,y:9},{x:7,y:9},{x:6,y:9}];
    dir = 'R';
    nextDir = 'R';
    score = 0;
    tickMs = 110;
    running = true;
    paused = true;       // NON parte da solo
    dead = false;
    waitingStart = true; // in attesa di A/START
    spawnFood();
    updateHUD();
    msgEl.textContent = 'Premi A o START per iniziare. B = Restart.';
    acc = 0;
    last = performance.now();
    draw(false);
  }

  function setDir(d) {
    const opposite = {U:'D',D:'U',L:'R',R:'L'};
    if (d !== opposite[dir]) nextDir = d;
  }

  function gameOver() {
    dead = true;
    waitingStart = false;
    paused = true;
    msgEl.textContent = 'GAME OVER. Premi A/START o B per ricominciare.';
    draw(true);
  }

  function step() {
    if (!running || paused || dead || waitingStart) return;

    dir = nextDir;
    const head = snake[0];
    const nx = head.x + (dir==='L'?-1:dir==='R'?1:0);
    const ny = head.y + (dir==='U'?-1:dir==='D'?1:0);

    if (nx < 0 || ny < 0 || nx >= GRID || ny >= GRID) return gameOver();
    const hit = snake.some((p,i) => i>0 && p.x===nx && p.y===ny);
    if (hit) return gameOver();

    snake.unshift({x:nx,y:ny});

    if (nx === food.x && ny === food.y) {
      score = Math.min(999, score + 5);
      best = Math.max(best, score);
      localStorage.setItem(storageBest, String(best));
      tickMs = Math.max(70, tickMs - 2);
      spawnFood();
      updateHUD();
    } else {
      snake.pop();
    }
  }

  function draw(isOver=false) {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = 'rgba(0,0,0,.06)';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // griglia
    ctx.strokeStyle = 'rgba(20,32,22,.10)';
    ctx.lineWidth = 1;
    for (let i=1;i<GRID;i++){
      ctx.beginPath(); ctx.moveTo(i*CELL,0); ctx.lineTo(i*CELL,canvas.height); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(0,i*CELL); ctx.lineTo(canvas.width,i*CELL); ctx.stroke();
    }

    // food
    ctx.fillStyle = INK;
    ctx.fillRect(food.x*CELL + 5, food.y*CELL + 5, CELL-10, CELL-10);

    // snake
    ctx.fillStyle = INK;
    snake.forEach((p,i) => {
      const inset = i===0 ? 2 : 3;
      ctx.fillRect(p.x*CELL + inset, p.y*CELL + inset, CELL-2*inset, CELL-2*inset);
    });

    const showOverlay = paused || isOver || waitingStart;
    if (showOverlay) {
      ctx.fillStyle = 'rgba(255,255,255,.35)';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = INK;
      ctx.font = '900 18px ui-monospace, Menlo, Monaco, Consolas, monospace';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      const label = isOver ? 'GAME OVER' : (waitingStart ? 'PRESS A/START' : 'PAUSA');
      ctx.fillText(label, canvas.width/2, canvas.height/2);
    }
  }

  function loop(t){
    rafId = requestAnimationFrame(loop);
    const dt = t - last;
    last = t;

    acc += Math.min(50, dt);
    while (acc >= tickMs) {
      step();
      acc -= tickMs;
    }
    draw(false);
  }

  function startOrToggle(){
    // game over -> restart e start
    if (dead) {
      reset();
      waitingStart = false;
      paused = false;
      msgEl.textContent = 'PLAY';
      return;
    }
    // start screen -> start
    if (waitingStart) {
      waitingStart = false;
      paused = false;
      msgEl.textContent = 'PLAY';
      return;
    }
    // in game -> toggle pausa
    paused = !paused;
    msgEl.textContent = paused ? 'PAUSA (A/START per riprendere)' : 'PLAY';
  }

  // binding anti doppio evento
  function bindPress(id, fn){
    const el = document.getElementById(id);
    let lockUntil = 0;

    const run = () => {
      const now = performance.now();
      if (now < lockUntil) return;
      lockUntil = now + 250;

      el.style.transform = 'translateY(1px)';
      setTimeout(() => el.style.transform = '', 80);

      fn();
    };

    el.addEventListener('pointerup', (e) => { e.preventDefault(); run(); });
    el.addEventListener('click', (e) => { e.preventDefault(); run(); });
    el.addEventListener('touchend', (e) => { e.preventDefault(); run(); }, {passive:false});
  }

  bindPress('btnA', startOrToggle);
  bindPress('btnStart', startOrToggle);
  bindPress('btnB', () => { reset(); }); // restart immediato
  bindPress('btnSel', () => { msgEl.textContent = 'TIP: più mangi, più accelera.'; });

  // D-Pad
  document.querySelectorAll('.dpad button[data-dir]').forEach(btn => {
    const d = btn.dataset.dir;
    btn.addEventListener('pointerup', (e) => { e.preventDefault(); setDir(d); });
    btn.addEventListener('click', (e) => { e.preventDefault(); setDir(d); });
    btn.addEventListener('touchend', (e) => { e.preventDefault(); setDir(d); }, {passive:false});
  });

  // Tastiera
  window.addEventListener('keydown', (e) => {
    const k = e.key.toLowerCase();
    if (k === 'arrowup') setDir('U');
    else if (k === 'arrowdown') setDir('D');
    else if (k === 'arrowleft') setDir('L');
    else if (k === 'arrowright') setDir('R');
    else if (k === ' ' || k === 'enter' || k === 'a') startOrToggle();
    else if (k === 'r' || k === 'backspace' || k === 'b') reset();
  }, {passive:true});

  // Avvio
  reset();
  cancelAnimationFrame(rafId);
  rafId = requestAnimationFrame(loop);
})();
</script>
</body>
</html>

<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0e1a12" />
  <link rel="manifest" href="manifest.webmanifest">
  <title>GB Snake — Free</title>
  <style>
    :root{
      --bg:#0a120d;
      --shell:#c9c7b8;
      --shell2:#bdbbad;
      --bezel:#1b2a21;
      --screen:#b9caa6;
      --screen2:#9fb18f;
      --ink:#142016;
      --btn:#6b6a63;
      --btn2:#5b5a54;
      --accent:#9a2240;
      --shadow: rgba(0,0,0,.28);
      --radius: 22px;
      --font: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --pixel: 12; /* dimensione cella */
    }
    *{box-sizing:border-box}
    body{
      margin:0; background: radial-gradient(1200px 800px at 50% -10%, #1b2a21, var(--bg));
      color:#eef3ea; font-family: var(--font);
      min-height:100svh; display:flex; align-items:center; justify-content:center;
      padding:16px;
    }
    .wrap{width:min(440px, 100%);}

    .handheld{
      background: linear-gradient(180deg, var(--shell), var(--shell2));
      border-radius: 34px;
      box-shadow: 0 18px 60px var(--shadow);
      padding: 18px 18px 22px;
      border: 1px solid rgba(255,255,255,.35);
      position: relative;
      overflow: hidden;
    }
    .handheld:before{
      content:""; position:absolute; inset:-40px -40px auto auto; width:140px; height:140px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.45), rgba(255,255,255,0));
      transform: rotate(18deg);
      pointer-events:none;
    }
    .brand{
      display:flex; align-items:center; justify-content:space-between;
      padding: 2px 6px 10px;
      color:#2c3a31; font-weight:700; letter-spacing:.08em; font-size:12px;
    }
    .brand small{opacity:.75; font-weight:700}
    .screen-bezel{
      background: linear-gradient(180deg, #22352b, var(--bezel));
      border-radius: 18px;
      padding: 14px;
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: inset 0 10px 20px rgba(0,0,0,.28);
    }
    .screen{
      background: linear-gradient(180deg, var(--screen), var(--screen2));
      border-radius: 10px;
      padding: 12px;
      border: 1px solid rgba(0,0,0,.25);
      position: relative;
    }
    canvas{
      width:100%; height:auto; display:block;
      image-rendering: pixelated;
      border-radius: 8px;
      background: rgba(0,0,0,.08);
    }
    .hud{
      position:absolute; inset:10px 10px auto 10px;
      display:flex; justify-content:space-between; gap:10px;
      color: var(--ink);
      font-weight: 900;
      font-size: 12px;
      text-shadow: 0 1px 0 rgba(255,255,255,.18);
      pointer-events:none;
    }
    .hint{
      margin-top:10px; opacity:.85; font-size:12px; line-height:1.3;
      color:#1c2b22; background: rgba(255,255,255,.35);
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 12px; padding: 8px 10px;
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 18px;
      align-items:center;
    }
    .dpad{
      width: 160px; height: 160px;
      margin: 0 auto;
      position: relative;
      filter: drop-shadow(0 8px 12px rgba(0,0,0,.18));
      touch-action: manipulation;
    }
    .dpad button{
      position:absolute;
      border: 0;
      background: linear-gradient(180deg, var(--btn), var(--btn2));
      color: rgba(255,255,255,.8);
      font-weight: 900;
      border-radius: 14px;
      box-shadow: inset 0 2px 0 rgba(255,255,255,.18), 0 8px 16px rgba(0,0,0,.22);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .dpad .up{ left:50%; top:0; transform:translateX(-50%); width:58px; height:58px;}
    .dpad .down{ left:50%; bottom:0; transform:translateX(-50%); width:58px; height:58px;}
    .dpad .left{ left:0; top:50%; transform:translateY(-50%); width:58px; height:58px;}
    .dpad .right{ right:0; top:50%; transform:translateY(-50%); width:58px; height:58px;}
    .dpad .mid{
      left:50%; top:50%; transform:translate(-50%,-50%);
      width:62px; height:62px; border-radius: 18px;
      background: linear-gradient(180deg, #4f4e48, #3f3e39);
    }

    .ab{
      display:flex; justify-content:center; gap:14px; align-items:center;
      touch-action: manipulation;
    }
    .ab .big{
      width:66px; height:66px;
      border-radius: 999px;
      border:0;
      background: radial-gradient(circle at 30% 30%, #cf2a52, var(--accent));
      box-shadow: inset 0 2px 0 rgba(255,255,255,.18), 0 10px 18px rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      font-weight: 900;
      font-size: 16px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .ab .smallrow{ display:flex; gap:10px; margin-left:8px; }
    .ab .small{
      width:64px; height:30px;
      border-radius: 999px;
      border:0;
      background: linear-gradient(180deg, #78776f, #64635c);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.16), 0 8px 14px rgba(0,0,0,.18);
      color: rgba(255,255,255,.9);
      font-weight: 900;
      font-size: 12px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    .footer{
      display:flex; justify-content:space-between; gap:12px; margin-top: 10px;
      color:#24332a; font-size:11px; opacity:.9;
      padding: 0 6px;
    }
    a{ color:inherit }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="handheld">
      <div class="brand">
        <div>GB SNAKE <small>FREE</small></div>
        <div id="installHint" style="opacity:.75; font-weight:800;">Installabile</div>
      </div>

      <div class="screen-bezel">
        <div class="screen">
          <div class="hud">
            <div id="score">SCORE 000</div>
            <div id="best">BEST 000</div>
          </div>
          <canvas id="c" width="256" height="256" aria-label="Gioco Snake"></canvas>
          <div class="hint" id="msg">
            Tocca il D-Pad o usa ↑ ↓ ← →. A = Start/Pausa. B = Restart.
          </div>
        </div>
      </div>

      <div class="controls">
        <div class="dpad" aria-label="D-Pad">
          <button class="up" data-dir="U">▲</button>
          <button class="down" data-dir="D">▼</button>
          <button class="left" data-dir="L">◀</button>
          <button class="right" data-dir="R">▶</button>
          <div class="mid"></div>
        </div>

        <div class="ab" aria-label="Pulsanti">
          <button class="big" id="btnA">A</button>
          <button class="big" id="btnB">B</button>
          <div class="smallrow">
            <button class="small" id="btnSel">SEL</button>
            <button class="small" id="btnStart">START</button>
          </div>
        </div>
      </div>

      <div class="footer">
        <div>Offline ✔︎</div>
        <div>© Free mini-PWA</div>
      </div>
    </div>
  </div>

<script>
(() => {
  // --- PWA service worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
  }

  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  const scoreEl = document.getElementById('score');
  const bestEl  = document.getElementById('best');
  const msgEl   = document.getElementById('msg');

  const GRID = 16;                  // 16x16 celle
  const CELL = canvas.width / GRID; // 16px
  const INK  = '#142016';

  const storageBest = 'gb_snake_best_v1';
  let best = Number(localStorage.getItem(storageBest) || 0);

  function pad3(n){ return String(n).padStart(3,'0'); }
  function updateHUD() {
    scoreEl.textContent = `SCORE ${pad3(score)}`;
    bestEl.textContent  = `BEST ${pad3(best)}`;
  }

  // Game state
  let snake, dir, nextDir, food, score, tickMs, timer, running, paused, dead;

  function reset() {
    snake = [{x:8,y:9},{x:7,y:9},{x:6,y:9}];
    dir = 'R';
    nextDir = 'R';
    score = 0;
    tickMs = 120; // velocità base
    dead = false;
    paused = false;
    running = true;
    spawnFood();
    updateHUD();
    msgEl.textContent = 'A = Pausa/Start. B = Restart. Buona caccia.';
    loop();
  }

  function spawnFood() {
    const occupied = new Set(snake.map(p => `${p.x},${p.y}`));
    while (true) {
      const x = Math.floor(Math.random()*GRID);
      const y = Math.floor(Math.random()*GRID);
      if (!occupied.has(`${x},${y}`)) { food = {x,y}; return; }
    }
  }

  function setDir(d) {
    const opposite = {U:'D',D:'U',L:'R',R:'L'};
    // evita inversione istantanea
    if (d !== opposite[dir]) nextDir = d;
  }

  function step() {
    if (!running || paused || dead) return;

    dir = nextDir;
    const head = snake[0];
    const nx = head.x + (dir==='L'?-1:dir==='R'?1:0);
    const ny = head.y + (dir==='U'?-1:dir==='D'?1:0);

    // collisioni con bordo
    if (nx < 0 || ny < 0 || nx >= GRID || ny >= GRID) return gameOver();

    // collisioni con sé stessa
    const hit = snake.some((p,i) => i>0 && p.x===nx && p.y===ny);
    if (hit) return gameOver();

    // muovi
    snake.unshift({x:nx,y:ny});

    // mangia
    if (nx === food.x && ny === food.y) {
      score = Math.min(999, score + 5);
      best = Math.max(best, score);
      localStorage.setItem(storageBest, String(best));
      // aumenta leggermente velocità
      tickMs = Math.max(70, tickMs - 2);
      spawnFood();
      updateHUD();
    } else {
      snake.pop();
    }
  }

  function gameOver() {
    dead = true;
    msgEl.textContent = 'GAME OVER. Premi B per ricominciare.';
    draw(true);
  }

  function draw(isOver=false) {
    // sfondo schermo
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = 'rgba(0,0,0,.06)';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // griglia leggera
    ctx.strokeStyle = 'rgba(20,32,22,.10)';
    ctx.lineWidth = 1;
    for (let i=1;i<GRID;i++){
      ctx.beginPath(); ctx.moveTo(i*CELL,0); ctx.lineTo(i*CELL,canvas.height); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(0,i*CELL); ctx.lineTo(canvas.width,i*CELL); ctx.stroke();
    }

    // food
    ctx.fillStyle = INK;
    ctx.fillRect(food.x*CELL + 5, food.y*CELL + 5, CELL-10, CELL-10);

    // snake
    ctx.fillStyle = INK;
    snake.forEach((p,i) => {
      const inset = i===0 ? 2 : 3;
      ctx.fillRect(p.x*CELL + inset, p.y*CELL + inset, CELL-2*inset, CELL-2*inset);
    });

    // overlay pausa / gameover
    if (paused || isOver) {
      ctx.fillStyle = 'rgba(255,255,255,.35)';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = INK;
      ctx.font = '900 18px ' + getComputedStyle(document.body).fontFamily;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(isOver ? 'GAME OVER' : 'PAUSA', canvas.width/2, canvas.height/2);
    }
  }

  function loop() {
    clearInterval(timer);
    timer = setInterval(() => {
      step();
      draw(false);
    }, tickMs);

    // “adaptive loop”: ricalibra quando tickMs cambia (mangiando)
    const adapt = setInterval(() => {
      if (!running) { clearInterval(adapt); return; }
      clearInterval(timer);
      timer = setInterval(() => { step(); draw(false); }, tickMs);
    }, 250);
  }

  // Input: tastiera
  window.addEventListener('keydown', (e) => {
    const k = e.key.toLowerCase();
    if (k === 'arrowup') setDir('U');
    else if (k === 'arrowdown') setDir('D');
    else if (k === 'arrowleft') setDir('L');
    else if (k === 'arrowright') setDir('R');
    else if (k === ' ' || k === 'enter') togglePause();
    else if (k === 'r' || k === 'backspace') reset();
  }, {passive:true});

  // Input: D-pad touch/click
  document.querySelectorAll('.dpad button[data-dir]').forEach(btn => {
    const d = btn.dataset.dir;
    const h = () => setDir(d);
    btn.addEventListener('pointerdown', h);
    btn.addEventListener('click', h);
  });

  // Buttons A/B/Start/Select
  function togglePause(){
    if (!running) return;
    if (dead) return;
    paused = !paused;
    msgEl.textContent = paused ? 'In pausa. Premi A/Start per riprendere.' : 'Vai.';
    draw(false);
  }
  document.getElementById('btnA').addEventListener('click', togglePause);
  document.getElementById('btnStart').addEventListener('click', togglePause);
  document.getElementById('btnB').addEventListener('click', reset);
  document.getElementById('btnSel').addEventListener('click', () => {
    // mini “mute” visivo: solo messaggio
    msgEl.textContent = 'Tip: più mangi, più accelera. (↑↓←→ o D-Pad)';
  });

  // Avvio
  updateHUD();
  draw(false);
  reset();
})();
</script>
</body>
</html>
